# Certificate Management Service 
------------------------------

## Installation Answer File Options

| Key                                | Sample Value                                               | Description                                                  |
| ---------------------------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| CMS\_NOSETUP                       | false                                                      | Determines whether “setup” will be executed after installation. Typically this is set to “false” to install and perform setup in one action. The “true” option is intended for building the service as a container, where the installation would be part of the image build, and setup would be performed when the container starts for the first time to generate any persistent data. |
| CMS\_PORT                          | 8445                                                       | Defines the HTTPS port the service will use.                 |
| AAS\_API\_URL                      | https://\<Hostname or IP address of the AAS\>:8444/aas/v1/ | URL to connect to the AAS, used during setup for authentication. |
| AAS\_TLS\_SAN                      | \<Comma-separated list of IPs/hostnames for the AAS\>      | SAN list populated in special JWT token, this token is used by AAS to get TLS certificate signed from CMS. SAN list in this token and CSR generated by AAS must match. |
| LOG\_ROTATION\_PERIOD              | hourly, daily, weekly, monthly, yearly                     | log rotation period, for more details refer- https://linux.die.net/man/8/logrotate |
| LOG\_COMPRESS                      | Compress                                                   | Old versions of log files are compressed with gzip, for more details refer- https://linux.die.net/man/8/logrotate |
| LOG\_DELAYCOMPRESS                 | delaycompress                                              | Postpone compression of the previous log file to the next rotation cycle, for more details refer- https://linux.die.net/man/8/logrotate |
| LOG\_COPYTRUNCATE                  | Copytruncate                                               | Truncate the original log file in place after creating a copy,'create' creates new one, for more details refer- https://linux.die.net/man/8/logrotate |
| LOG\_SIZE                          | 1K                                                         | Log files are rotated when they grow bigger than size bytes, for more details refer- https://linux.die.net/man/8/logrotate |
| LOG\_OLD                           | 12                                                         | Log files are rotated count times before being removed, for more details refer- https://linux.die.net/man/8/logrotate |
| CMS\_CA\_CERT\_VALIDITY            | 5                                                          | CMS Root Certificate Validity in years                       |
| CMS\_CA\_ORGANIZATION              | INTEL                                                      | CMS Certificate Organization                                 |
| CMS\_CA\_LOCALITY                  | US                                                         | CMS Certificate locality                                     |
| CMS\_CA\_PROVINCE                  | CA                                                         | CMS Certificate province                                     |
| CMS\_CA\_COUNTRY                   | USA                                                        | CMS Certificate country                                      |
| CMS\_TLS\_SAN\_LIST                |                                                            | Comma-separated list of IP addresses and hostnames to be added to the SAN list of CMS server |
| CMS\_SERVER\_READ\_TIMEOUT         | 30s                                                        | MS server - ReadTimeout is the maximum duration for reading the entire request, including the body. |
| CMS\_SERVER\_READ\_HEADER\_TIMEOUT | 10s                                                        | CMS server - ReadHeaderTimeout is the amount of time allowed to read request headers |
| CMS\_SERVER\_WRITE\_TIMEOUT        | 10s                                                        | CMS server - WriteTimeout is the maximum duration before timing out writes of the response. |
| CMS\_SERVER\_IDLE\_TIMEOUT         | 10s                                                        | CMS server - IdleTimeout is the maximum amount of time to wait for the next request when keep-alives are enabled. |
| CMS\_SERVER\_MAX\_HEADER\_BYTES    | 1048576                                                    | CMS server - MaxHeaderBytes controls the maximum number of bytes the server will read parsing the request header's keys and values, including the request line. |
| AAS\_JWT\_CN                       | AAS JWT Signing Certificate                                | CN of AAS JWT certificate, this gets populated in special JWT token. AAS must send JWT certificate CSR with this CN. |
| AAS\_TLS\_CN                       | AAS TLS Certificate                                        | CN of AAS TLS certificate, this gets populated in special JWT token. AAS must send TLS certificate CSR with this CN. |
| AAS\_TLS\_SAN                      |                                                            | SAN list populated in special JWT token, this token is used by AAS to get TLS certificate signed from CMS. SAN list in this token and CSR generated by AAS must match. |

## Configuration Options

The CMS configuration can be found in `/etc/cms/config.yml`

```yaml
port: 8445
loglevel: info
authserviceurl: https://<AAS IP or hostname>:8444/aas/v1/
cacertvalidity: 5
organization: INTEL
locality: SC
province: CA
country: US
keyalgorithm: rsa
keyalgorithmlength: 3072
rootcacertdigest: <sha384>
tlscertdigest: <sha384>
tokendurationmins: 20
aasjwtcn: ""
aastlscn: ""
aastlssan: ""
authdefender:
  maxattempts: 5
  intervalmins: 5
  lockoutdurationmins: 15
```

## Command-Line Options

### Help
```
cms help
```
Displays the list of available CLI commands.

### Start
```
cms start
```
Starts the services.

### Stop
```
cms stop
```
Stops the service.

### Status
```
cms status
```
Reports whether the service is currently running.

### Uninstall
```
cms uninstall
```
Uninstalls the service, including the deletion of all files and folders.

### Version
```
cms version
```
Reports the version of the service.

### Tlscertsha384

Shows the SHA384 of the TLS certificate.

### setup \[task\]
```yaml
Usage of cms setup:
        cms setup <task> [--help] [--force] [-f <answer-file>]
                --help                      show help message for setup task
                --force                     existing configuration will be overwritten if this flag is set
                -f|--file <answer-file>     the answer file with required arguments

Available Tasks for setup:
    all                       Runs all setup tasks
    root-ca                   Creates a self signed Root CA key pair in /etc/cms/root-ca/ for quality of life
    intermediate-ca           Creates a Root CA signed intermediate CA key pair(signing, tls-server and tls-client) in /etc/cms/intermediate-ca/ for quality of life
    tls                       Creates an intermediate-ca signed TLS key pair in /etc/cms for quality of life
    cms-auth-token            Create its own self signed JWT key pair in /etc/cms/jwt for quality of life
    update-service-config     Sets or Updates the Service configuration
```
## Directory Layout

The Certificate Management Service installs by default to `/opt/cms` with
the following folders.

### Bin

This folder contains executable scripts.

### Cacerts

This folder contains the CMS root CA certificate.
